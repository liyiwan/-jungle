<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC  
        "-//Hibernate/Hibernate Mapping DTD 3.0//EN"  
        "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">  
<hibernate-mapping>  
	<sql-query name="StockWarningGoods">
		<![CDATA[
			SELECT Goods.GoodsID AS GoodsId, Goods.GoodsNO AS GoodsNo, Goods.GoodsName AS GoodsName,
			       Goods.Stock AS Stock,
			       Goods.SellCountMonth AS SellCountMonth,
			       Goods.ProviderID AS ProviderId,
			       Goods.Remark AS Remark,
			       MyGoods.PicPath AS PicPath
			FROM
				(
					SELECT a.GoodsID AS GoodsID, a.GoodsNO AS GoodsNO, a.GoodsName AS GoodsName, a.bBlockUp AS bBlockUp, a.Remark AS Remark,
					       (SELECT ISNULL(SUM(stock),0) FROM G_Stock_Spec WHERE GoodsID=a.GoodsID) AS Stock,
					       (SELECT ISNULL(SUM(SellCount),0) FROM G_sta_SellDay WHERE GoodsID = a.GoodsID AND datediff(day, staDay, getdate()) < 31) AS SellCountMonth,
					b.ProviderID AS ProviderID, c.OrderPos AS OrderPos
					FROM G_Goods_GoodsList a, G_Goods_Provider b, G_Cfg_ProviderList c
					WHERE a.GoodsID = b.GoodsID AND b.ProviderID = c.ProviderID AND a.bBlockUp = 0 AND a.FlagID <> 13 AND c.ClassID = :classId AND a.GoodsID IN (SELECT DISTINCT G_Goods_GoodsSpec.GoodsID FROM G_Stock_Spec,G_Goods_GoodsSpec WHERE G_Stock_Spec.GoodsID=G_Goods_GoodsSpec.GoodsID AND G_Stock_Spec.SpecID=G_Goods_GoodsSpec.SpecID AND G_Stock_Spec.Stock = 0 AND G_Goods_GoodsSpec.FlagID <> 13)
				) Goods LEFT JOIN J_MyGoods MyGoods ON Goods.GoodsID = MyGoods.GoodsID
			WHERE Goods.Stock < 50 AND (MyGoods.StockWarningDate IS NULL OR MyGoods.StockWarningDate < GETDATE()) ORDER BY Goods.OrderPos
		]]>
	</sql-query>
	<sql-query name="StockSpecByGoods">
		<![CDATA[
			SELECT StockSpec.GoodsID AS GoodsId,StockSpec.SpecID AS SpecId,GoodsSpec.SpecName AS SpecName,GoodsSpec.FlagID AS FlagId,SUM(StockSpec.Stock) AS Stock
			FROM G_Stock_Spec StockSpec, G_Goods_GoodsSpec GoodsSpec
			WHERE StockSpec.GoodsID = GoodsSpec.GoodsID AND StockSpec.SpecID = GoodsSpec.SpecID AND StockSpec.GoodsID = :goodsId
			Group By StockSpec.GoodsID,StockSpec.SpecID,GoodsSpec.SpecName,GoodsSpec.FlagID
		]]>
	</sql-query>
	<sql-query name="SoldOutGoods">
		<![CDATA[
			SELECT G_Goods_GoodsList.GoodsID AS GoodsId,
			       G_Goods_GoodsList.GoodsNO AS GoodsNo,
			       G_Goods_GoodsList.GoodsName AS GoodsName,
			       J_MyGoods.PicPath AS PicPath
			FROM   G_Goods_GoodsList LEFT JOIN J_MyGoods ON G_Goods_GoodsList.GoodsID = J_MyGoods.GoodsID
			WHERE  G_Goods_GoodsList.GoodsID IN (SELECT G_Goods_GoodSspec.GoodsID AS GoodsID FROM G_Goods_GoodSspec LEFT JOIN G_Stock_Spec ON G_Goods_GoodSspec.GoodsID=G_Stock_Spec.GoodsID GROUP BY G_Goods_GoodSspec.GoodsID HAVING SUM(G_Stock_Spec.Stock) <= 0)
		]]>
	</sql-query>
</hibernate-mapping>
